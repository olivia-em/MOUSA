<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μοῦσα</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="minimal-container">
        <!-- Translation display - centered -->
        <div id="translationDisplay" class="translation-display hidden">
            <div id="textContent" class="text-content english"></div>
        </div>

        <!-- Fixed floating button - bottom right -->
        <button id="cycleBtn" class="floating-btn">
            <span class="btn-text">▶</span>
        </button>
    </div>

    <script>
        class TranslationCycle {
            constructor() {
                this.currentCycle = 0;
                this.currentText = '';
                this.originalGreek = '';
                this.isLoading = false;
                
                this.ttsSettings = {
                    rate: 0.6,
                    pitch: 0.8,
                    volume: 1.0,
                    lang: 'el-GR'
                };
                
                this.init();
            }

            async init() {
                await this.loadOriginalText();
                this.setupEventListeners();
                this.enableButton();
            }

            async loadOriginalText() {
                try {
                    const response = await fetch('/api/passages/odyssey_book1');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.originalGreek = data.content;
                    this.currentText = this.originalGreek;
                } catch (error) {
                    console.error('Failed to load original text:', error);
                    this.showError('Failed to load text');
                }
            }

            setupEventListeners() {
                const btn = document.getElementById('cycleBtn');
                btn.addEventListener('click', () => this.handleCycleClick());
            }

            enableButton() {
                const btn = document.getElementById('cycleBtn');
                btn.disabled = false;
                btn.classList.remove('loading');
            }

            async handleCycleClick() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading();

                try {
                    if (this.currentCycle === 0) {
                        // First click: Greek → English
                        await this.firstCycle();
                    } else {
                        // Subsequent clicks: English → Greek → English
                        await this.subsequentCycle();
                    }
                } catch (error) {
                    console.error('Cycle failed:', error);
                    this.showError('Translation failed');
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }

            async firstCycle() {
                // Translate Greek to English first
                const response = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: this.originalGreek,
                        is_greek: true
                    })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);

                // Store the translation and prepare for synchronized display
                this.currentText = result.translation;
                this.currentCycle = 1;

                // Start audio and word fade-in simultaneously
                await this.playWithFadeIn(this.originalGreek, this.currentText);
            }

            async subsequentCycle() {
                // Current text is English, translate to Greek first
                const toGreekResponse = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: this.currentText,
                        is_greek: false
                    })
                });

                const greekResult = await toGreekResponse.json();
                if (greekResult.error) throw new Error(greekResult.error);

                // Translate back to English
                const toEnglishResponse = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: greekResult.translation,
                        is_greek: true
                    })
                });

                const englishResult = await toEnglishResponse.json();
                if (englishResult.error) throw new Error(englishResult.error);

                // Store the translation and prepare for synchronized display
                this.currentText = englishResult.translation;
                this.currentCycle++;

                // Start audio and word fade-in simultaneously
                await this.playWithFadeIn(greekResult.translation, this.currentText);
            }

            async playGreekAudio(greekText) {
                return new Promise((resolve) => {
                    if (!window.speechSynthesis) {
                        console.warn('TTS not supported');
                        resolve();
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(greekText);
                    utterance.lang = this.ttsSettings.lang;
                    utterance.rate = this.ttsSettings.rate;
                    utterance.pitch = this.ttsSettings.pitch;
                    utterance.volume = this.ttsSettings.volume;
                    
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve();
                    
                    window.speechSynthesis.speak(utterance);
                });
            }

            async playWithTypewriter(greekText, englishText) {
                // Prepare the display element
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = '';
                display.classList.remove('hidden');

                // Calculate timing for synchronization
                const estimatedAudioDuration = this.estimateAudioDuration(greekText);
                const typewriterDelay = Math.max(30, estimatedAudioDuration / englishText.length);

                // Start audio and typewriter simultaneously
                const audioPromise = this.playGreekAudio(greekText);
                const typewriterPromise = this.typewriterEffect(englishText, typewriterDelay);

                // Wait for both to complete
                await Promise.all([audioPromise, typewriterPromise]);
            }

            estimateAudioDuration(text) {
                // Estimate speech duration: roughly 150 words per minute for Greek
                // Accounting for slower rate (0.6) = ~90 words per minute
                const words = text.split(/\s+/).length;
                const wordsPerMinute = 90;
                const durationMs = (words / wordsPerMinute) * 60 * 1000;
                return Math.max(2000, durationMs); // Minimum 2 seconds
            }

            async typewriterEffect(text, charDelay) {
                const content = document.getElementById('textContent');
                
                for (let i = 0; i <= text.length; i++) {
                    content.textContent = text.substring(0, i);
                    if (i < text.length) {
                        await this.delay(charDelay);
                    }
                }
            }

            displayResult(text) {
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = text;
                display.classList.remove('hidden');
            }

            showLoading() {
                const btn = document.getElementById('cycleBtn');
                btn.classList.add('loading');
                btn.querySelector('.btn-text').textContent = '⏳';
            }

            hideLoading() {
                const btn = document.getElementById('cycleBtn');
                btn.classList.remove('loading');
                btn.querySelector('.btn-text').textContent = '▶';
            }

            showError(message) {
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = message;
                content.className = 'text-content error';
                display.classList.remove('hidden');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            new TranslationCycle();
        });
    </script>
</body>
</html>

    <script>
        class TranslationCycle {
            constructor() {
                this.currentCycle = 0;
                this.currentText = '';
                this.originalGreek = '';
                this.isLoading = false;
                
                this.ttsSettings = {
                    rate: 0.6,
                    pitch: 0.8,
                    volume: 1.0,
                    lang: 'el-GR'
                };
                
                this.init();
            }

            async init() {
                await this.loadOriginalText();
                this.setupEventListeners();
                this.enableButton();
            }

            async loadOriginalText() {
                try {
                    const response = await fetch('/api/passages/odyssey_book1');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.originalGreek = data.content;
                    this.currentText = this.originalGreek;
                } catch (error) {
                    console.error('Failed to load original text:', error);
                    this.showError('Failed to load Odyssey text');
                }
            }

            setupEventListeners() {
                const btn = document.getElementById('cycleBtn');
                btn.addEventListener('click', () => this.handleCycleClick());
            }

            enableButton() {
                const btn = document.getElementById('cycleBtn');
                btn.disabled = false;
                btn.classList.remove('loading');
            }

            async handleCycleClick() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading();

                try {
                    if (this.currentCycle === 0) {
                        // First click: Greek → English
                        await this.firstCycle();
                    } else {
                        // Subsequent clicks: English → Greek → English
                        await this.subsequentCycle();
                    }
                } catch (error) {
                    console.error('Cycle failed:', error);
                    this.showError('Translation failed. Please try again.');
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }

            async firstCycle() {
                // Play original Greek audio
                await this.playGreekAudio(this.originalGreek);
                
                // Translate Greek to English
                const response = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: this.originalGreek,
                        is_greek: true
                    })
                });

                const result = await response.json();
                if (result.error) throw new Error(result.error);

                // Display English translation
                this.currentText = result.translation;
                this.currentCycle = 1;
                this.displayResult(this.currentText);
                this.updateCounter();
            }

            async subsequentCycle() {
                // Current text is English, translate to Greek first
                const toGreekResponse = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: this.currentText,
                        is_greek: false
                    })
                });

                const greekResult = await toGreekResponse.json();
                if (greekResult.error) throw new Error(greekResult.error);

                // Play the intermediate Greek audio
                await this.playGreekAudio(greekResult.translation);

                // Translate back to English
                const toEnglishResponse = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: greekResult.translation,
                        is_greek: true
                    })
                });

                const englishResult = await toEnglishResponse.json();
                if (englishResult.error) throw new Error(englishResult.error);

                // Display new English translation
                this.currentText = englishResult.translation;
                this.currentCycle++;
                this.displayResult(this.currentText);
                this.updateCounter();
            }

            async playGreekAudio(greekText) {
                return new Promise((resolve) => {
                    if (!window.speechSynthesis) {
                        console.warn('TTS not supported');
                        resolve();
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(greekText);
                    utterance.lang = this.ttsSettings.lang;
                    utterance.rate = this.ttsSettings.rate;
                    utterance.pitch = this.ttsSettings.pitch;
                    utterance.volume = this.ttsSettings.volume;
                    
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve();
                    
                    window.speechSynthesis.speak(utterance);
                });
            }

            async playWithTypewriter(greekText, englishText) {
                // Prepare the display element
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = '';
                display.classList.remove('hidden');

                // Calculate timing for synchronization
                const estimatedAudioDuration = this.estimateAudioDuration(greekText);
                const typewriterDelay = Math.max(30, estimatedAudioDuration / englishText.length);

                // Start audio and typewriter simultaneously
                const audioPromise = this.playGreekAudio(greekText);
                const typewriterPromise = this.typewriterEffect(englishText, typewriterDelay);

                // Wait for both to complete
                await Promise.all([audioPromise, typewriterPromise]);
            }

            estimateAudioDuration(text) {
                // Estimate speech duration: roughly 150 words per minute for Greek
                // Accounting for slower rate (0.6) = ~90 words per minute
                const words = text.split(/\s+/).length;
                const wordsPerMinute = 90;
                const durationMs = (words / wordsPerMinute) * 60 * 1000;
                return Math.max(2000, durationMs); // Minimum 2 seconds
            }

            async typewriterEffect(text, charDelay) {
                const content = document.getElementById('textContent');
                
                for (let i = 0; i <= text.length; i++) {
                    content.textContent = text.substring(0, i);
                    if (i < text.length) {
                        await this.delay(charDelay);
                    }
                }
            }

            displayResult(text) {
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = text;
                display.classList.remove('hidden');
            }

            updateCounter() {
                const counter = document.getElementById('cycleCounter');
                const number = document.getElementById('cycleNumber');
                
                number.textContent = this.currentCycle;
                counter.classList.remove('hidden');
            }

            showLoading() {
                const btn = document.getElementById('cycleBtn');
                btn.classList.add('loading');
                btn.querySelector('.btn-text').textContent = '⏳';
            }

            hideLoading() {
                const btn = document.getElementById('cycleBtn');
                btn.classList.remove('loading');
                btn.querySelector('.btn-text').textContent = '▶';
            }

            showError(message) {
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                
                content.textContent = message;
                content.className = 'text-content error';
                display.classList.remove('hidden');
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            new TranslationCycle();
        });
    </script>
</body>
</html>
        </footer>
    </div>

    <script>
        class AudioTranslationCycle {
            constructor() {
                this.currentStep = 0;
                this.steps = [];
                this.isRunning = false;
                this.ttsSettings = {
                    rate: 0.6,
                    pitch: 0.8,
                    volume: 1.0,
                    lang: 'el-GR' // Greek locale for Ancient Greek approximation
                };
                
                this.initializeInterface();
                this.setupEventListeners();
            }

            initializeInterface() {
                // Enable the start button once interface is ready
                const startBtn = document.getElementById('startCycle');
                startBtn.disabled = false;
                startBtn.querySelector('.btn-text').style.display = 'block';
                startBtn.querySelector('.btn-loading').style.display = 'none';
            }

            setupEventListeners() {
                const startBtn = document.getElementById('startCycle');
                startBtn.addEventListener('click', () => this.startTranslationCycle());
            }

            async startTranslationCycle() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.showLoading();
                
                try {
                    // Fetch the translation cycle from the API
                    const response = await fetch('/api/cycle-translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            passage_name: 'odyssey_book1'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    this.steps = data.steps;
                    
                    // Start the audio-visual cycle
                    this.showProgress();
                    await this.runAudioVisualCycle();
                    
                } catch (error) {
                    console.error('Translation cycle failed:', error);
                    this.showError('Translation cycle failed. Please try again.');
                } finally {
                    this.isRunning = false;
                }
            }

            async runAudioVisualCycle() {
                for (let i = 0; i < this.steps.length; i++) {
                    const step = this.steps[i];
                    
                    // Update progress indicator
                    this.updateProgress(i + 1);
                    
                    // Display the text
                    this.displayText(step.text, step.language, step.description);
                    
                    // Play audio for Greek text only
                    if (step.language === 'greek') {
                        await this.speakGreekText(step.text);
                    }
                    
                    // Wait before next step (longer for reading English)
                    const delay = step.language === 'english' ? 4000 : 2000;
                    await this.wait(delay);
                }
                
                // Reset for next cycle
                setTimeout(() => this.resetInterface(), 2000);
            }

            async speakGreekText(greekText) {
                return new Promise((resolve) => {
                    if (!window.speechSynthesis) {
                        console.warn('Text-to-speech not supported');
                        resolve();
                        return;
                    }

                    const utterance = new SpeechSynthesisUtterance(greekText);
                    
                    // Configure for Ancient Greek approximation
                    utterance.lang = this.ttsSettings.lang;
                    utterance.rate = this.ttsSettings.rate;
                    utterance.pitch = this.ttsSettings.pitch;
                    utterance.volume = this.ttsSettings.volume;
                    
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve(); // Continue even if TTS fails
                    
                    window.speechSynthesis.speak(utterance);
                });
            }

            displayText(text, language, description) {
                const display = document.getElementById('translationDisplay');
                const content = document.getElementById('textContent');
                const languageLabel = document.getElementById('textLanguage');
                
                content.textContent = text;
                languageLabel.textContent = description;
                
                // Add language-specific styling
                content.className = `text-content ${language}`;
                
                display.classList.remove('hidden');
            }

            updateProgress(currentStep) {
                this.currentStep = currentStep;
                const steps = document.querySelectorAll('.step');
                
                steps.forEach((step, index) => {
                    if (index < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (index === currentStep - 1) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
            }

            showLoading() {
                const startBtn = document.getElementById('startCycle');
                startBtn.querySelector('.btn-text').style.display = 'none';
                startBtn.querySelector('.btn-loading').style.display = 'block';
                startBtn.disabled = true;
            }

            showProgress() {
                document.getElementById('progressIndicator').classList.remove('hidden');
            }

            showError(message) {
                const content = document.getElementById('textContent');
                const languageLabel = document.getElementById('textLanguage');
                
                content.textContent = message;
                languageLabel.textContent = 'Error';
                content.className = 'text-content error';
                
                document.getElementById('translationDisplay').classList.remove('hidden');
            }

            resetInterface() {
                // Reset button
                const startBtn = document.getElementById('startCycle');
                startBtn.querySelector('.btn-text').style.display = 'block';
                startBtn.querySelector('.btn-loading').style.display = 'none';
                startBtn.disabled = false;
                
                // Hide elements
                document.getElementById('progressIndicator').classList.add('hidden');
                document.getElementById('translationDisplay').classList.add('hidden');
                
                // Reset progress
                this.currentStep = 0;
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
            }

            wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the application
        window.addEventListener('DOMContentLoaded', () => {
            new AudioTranslationCycle();
        });
    </script>
</body>
</html>
