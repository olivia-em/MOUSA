<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μοῦσα - Odyssey Translation Explorer</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Μοῦσα Translation Explorer</h1>
            <p>Watch the Odyssey Book 1 degrade through translation cycles</p>
        </header>

        <main>
            <section class="odyssey-section">
                <div class="original-text">
                    <h2>The Odyssey - Book 1 (Original Ancient Greek)</h2>
                    <div id="originalGreek" class="greek-text loading">Loading Odyssey text...</div>
                </div>

                <div class="controls">
                    <button id="runTranslationCycle" class="btn-primary">Run Translation Cycle</button>
                    <div class="cycle-counter">
                        <span>Cycle: <strong id="cycleNumber">0</strong></span>
                    </div>
                </div>

                <div id="translationResults" class="translation-results">
                    <!-- Translation cycles will appear here -->
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Μοῦσα Translation Explorer</p>
        </footer>
    </div>

    <script>
        let currentCycle = 0;
        let currentText = '';
        let originalText = '';

        // Load the Odyssey text on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/passages/odyssey_book1');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('originalGreek').innerHTML = `<div class="error">Error loading text: ${data.error}</div>`;
                } else {
                    originalText = data.content;
                    currentText = originalText;
                    document.getElementById('originalGreek').innerHTML = `<div class="text-content">${originalText}</div>`;
                }
            } catch (error) {
                document.getElementById('originalGreek').innerHTML = `<div class="error">Failed to load Odyssey text: ${error.message}</div>`;
            }
        });

        // Handle translation cycle button
        document.getElementById('runTranslationCycle').addEventListener('click', async () => {
            if (!currentText) {
                alert('Odyssey text not loaded yet. Please wait.');
                return;
            }

            const button = document.getElementById('runTranslationCycle');
            const resultsDiv = document.getElementById('translationResults');
            
            // Disable button during processing
            button.disabled = true;
            button.textContent = 'Translating...';

            try {
                // Run one translation cycle: Greek → English → Greek
                const response = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: currentText,
                        is_greek: true
                    })
                });

                const englishResult = await response.json();
                
                if (englishResult.error) {
                    throw new Error(englishResult.error);
                }

                // Now translate back to Greek
                const backResponse = await fetch('/api/single-translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: englishResult.translation,
                        is_greek: false
                    })
                });

                const greekResult = await backResponse.json();
                
                if (greekResult.error) {
                    throw new Error(greekResult.error);
                }

                // Update cycle counter and current text
                currentCycle++;
                currentText = greekResult.translation;
                document.getElementById('cycleNumber').textContent = currentCycle;

                // Add the new cycle results
                const cycleDiv = document.createElement('div');
                cycleDiv.className = 'cycle-result';
                cycleDiv.innerHTML = `
                    <div class="cycle-header">
                        <h3>Cycle ${currentCycle}</h3>
                    </div>
                    <div class="translation-step">
                        <h4>Step 1: Greek → English</h4>
                        <div class="translation-text english">${englishResult.translation}</div>
                    </div>
                    <div class="translation-step">
                        <h4>Step 2: English → Greek</h4>
                        <div class="translation-text greek">${greekResult.translation}</div>
                    </div>
                `;

                resultsDiv.appendChild(cycleDiv);
                
                // Scroll to the new result
                cycleDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'cycle-result error';
                errorDiv.innerHTML = `<div class="error">Cycle ${currentCycle + 1} failed: ${error.message}</div>`;
                resultsDiv.appendChild(errorDiv);
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Run Translation Cycle';
            }
        });
    </script>
</body>
</html>
