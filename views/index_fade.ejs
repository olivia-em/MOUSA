<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Μοῦσα</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="minimal-container">
      <!-- Translation display - centered -->
      <div id="translationDisplay" class="translation-display hidden">
        <div id="textContent" class="text-content english"></div>
      </div>

      <!-- Fixed floating button - bottom right -->
      <button id="cycleBtn" class="floating-btn">
        <span class="btn-text">▶</span>
      </button>
    </div>

    <script>
      class TranslationCycle {
        constructor() {
          this.currentCycle = 0;
          this.currentText = "";
          this.originalGreek = "";
          this.isLoading = false;

          this.ttsSettings = {
            rate: 0.6,
            pitch: 0.8,
            volume: 1.0,
            lang: "el-GR",
          };

          this.init();
        }

        async init() {
          await this.loadOriginalText();
          this.setupEventListeners();
          this.enableButton();
        }

        async loadOriginalText() {
          try {
            const response = await fetch("/api/passages/odyssey_book1");
            const data = await response.json();

            if (data.error) {
              throw new Error(data.error);
            }

            this.originalGreek = data.content;
            this.currentText = this.originalGreek;
          } catch (error) {
            console.error("Failed to load original text:", error);
            this.showError("Failed to load text");
          }
        }

        setupEventListeners() {
          const btn = document.getElementById("cycleBtn");
          btn.addEventListener("click", () => this.handleCycleClick());
        }

        enableButton() {
          const btn = document.getElementById("cycleBtn");
          btn.disabled = false;
          btn.classList.remove("loading");
        }

        async handleCycleClick() {
          if (this.isLoading) return;

          this.isLoading = true;
          this.showLoading();

          try {
            if (this.currentCycle === 0) {
              // First click: Greek → English
              await this.firstCycle();
            } else {
              // Subsequent clicks: English → Greek → English
              await this.subsequentCycle();
            }
          } catch (error) {
            console.error("Cycle failed:", error);
            this.showError("Translation failed");
          } finally {
            this.isLoading = false;
            this.hideLoading();
          }
        }

        async firstCycle() {
          // Translate Greek to English first
          const response = await fetch("/api/single-translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text: this.originalGreek,
              is_greek: true,
            }),
          });

          const result = await response.json();
          if (result.error) throw new Error(result.error);

          // Store the translation and prepare for synchronized display
          this.currentText = result.translation;
          this.currentCycle = 1;

          // Start audio and word fade-in simultaneously
          await this.playWithFadeIn(this.originalGreek, this.currentText);
        }

        async subsequentCycle() {
          // Current text is English, translate to Greek first
          const toGreekResponse = await fetch("/api/single-translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text: this.currentText,
              is_greek: false,
            }),
          });

          const greekResult = await toGreekResponse.json();
          if (greekResult.error) throw new Error(greekResult.error);

          // Translate back to English
          const toEnglishResponse = await fetch("/api/single-translate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              text: greekResult.translation,
              is_greek: true,
            }),
          });

          const englishResult = await toEnglishResponse.json();
          if (englishResult.error) throw new Error(englishResult.error);

          // Store the translation and prepare for synchronized display
          this.currentText = englishResult.translation;
          this.currentCycle++;

          // Start audio and word fade-in simultaneously
          await this.playWithFadeIn(greekResult.translation, this.currentText);
        }

        async playWithFadeIn(greekText, englishText) {
          // Prepare the display element
          const display = document.getElementById("translationDisplay");
          const content = document.getElementById("textContent");

          content.innerHTML = "";
          display.classList.remove("hidden");

          // Calculate timing for synchronization
          const estimatedAudioDuration = this.estimateAudioDuration(greekText);
          const words = englishText.split(/\s+/);
          const wordDelay = Math.max(
            200,
            estimatedAudioDuration / words.length
          );

          // Start audio and word fade-in simultaneously
          const audioPromise = this.playGreekAudio(greekText);
          const fadePromise = this.fadeInByWord(words, wordDelay);

          // Wait for both to complete
          await Promise.all([audioPromise, fadePromise]);
        }

        estimateAudioDuration(text) {
          // Estimate speech duration: roughly 150 words per minute for Greek
          // Accounting for slower rate (0.6) = ~90 words per minute
          const words = text.split(/\s+/).length;
          const wordsPerMinute = 90;
          const durationMs = (words / wordsPerMinute) * 60 * 1000;
          return Math.max(2000, durationMs); // Minimum 2 seconds
        }

        async fadeInByWord(words, wordDelay) {
          const content = document.getElementById("textContent");

          for (let i = 0; i < words.length; i++) {
            const span = document.createElement("span");
            span.textContent = words[i] + (i < words.length - 1 ? " " : "");
            span.style.opacity = "0";
            span.style.transition = "opacity 0.5s ease-in";
            span.className = "fade-word";

            content.appendChild(span);

            // Trigger fade-in
            setTimeout(() => {
              span.style.opacity = "1";
            }, 10);

            if (i < words.length - 1) {
              await this.delay(wordDelay);
            }
          }
        }

        async playGreekAudio(greekText) {
          return new Promise((resolve) => {
            if (!window.speechSynthesis) {
              console.warn("TTS not supported");
              resolve();
              return;
            }

            const utterance = new SpeechSynthesisUtterance(greekText);
            utterance.lang = this.ttsSettings.lang;
            utterance.rate = this.ttsSettings.rate;
            utterance.pitch = this.ttsSettings.pitch;
            utterance.volume = this.ttsSettings.volume;

            utterance.onend = () => resolve();
            utterance.onerror = () => resolve();

            window.speechSynthesis.speak(utterance);
          });
        }

        displayResult(text) {
          const display = document.getElementById("translationDisplay");
          const content = document.getElementById("textContent");

          content.textContent = text;
          display.classList.remove("hidden");
        }

        showLoading() {
          const btn = document.getElementById("cycleBtn");
          btn.classList.add("loading");
          btn.querySelector(".btn-text").textContent = "⏳";
        }

        hideLoading() {
          const btn = document.getElementById("cycleBtn");
          btn.classList.remove("loading");
          btn.querySelector(".btn-text").textContent = "▶";
        }

        showError(message) {
          const display = document.getElementById("translationDisplay");
          const content = document.getElementById("textContent");

          content.textContent = message;
          content.className = "text-content error";
          display.classList.remove("hidden");
        }

        delay(ms) {
          return new Promise((resolve) => setTimeout(resolve, ms));
        }
      }

      // Initialize when page loads
      window.addEventListener("DOMContentLoaded", () => {
        new TranslationCycle();
      });
    </script>
  </body>
</html>
